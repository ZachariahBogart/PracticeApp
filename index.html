<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus 1 Interactive Study App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>

    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .content-view { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .content-view.active { display: block; opacity: 1; }
        
        .nav-item { @apply flex items-center px-4 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-700 rounded-lg transition-colors cursor-pointer mb-1; }
        .nav-item.active { @apply bg-blue-600 text-white shadow-md hover:bg-blue-700 hover:text-white; }

        /* MULTIPLE CHOICE BUTTONS */
        .btn-option { 
            @apply w-full text-left p-4 border-2 border-gray-200 rounded-xl mb-3 transition-all duration-200 text-gray-700 font-medium relative overflow-hidden bg-white; 
        }
        .btn-option:not(:disabled):hover {
            @apply bg-blue-50 border-blue-500 text-blue-900 shadow-md -translate-y-0.5 transform cursor-pointer;
        }
        .btn-option:not(:disabled):active {
            @apply bg-blue-100 border-blue-700 transform translate-y-0;
        }
        .btn-option.correct { 
            @apply bg-green-50 border-green-500 text-green-900 shadow-md; 
        }
        .btn-option.correct::after {
            content: '‚úì';
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #059669;
            font-size: 1.2rem;
        }
        .btn-option.wrong { 
            @apply bg-red-50 border-red-400 text-red-900 opacity-75; 
        }
        .btn-option.wrong::after {
            content: '‚úï';
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #dc2626;
            font-size: 1.2rem;
        }

        /* FRQ INPUT STYLES */
        .frq-input {
            @apply w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all;
        }
        .frq-input.error {
            @apply border-red-400 bg-red-50 animate-shake;
        }
        .frq-input.success {
            @apply border-green-500 bg-green-50;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        .chart-wrapper { position: relative; height: 200px; width: 100%; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-full md:w-72 bg-white border-r border-gray-200 flex flex-col z-20 shadow-lg flex-shrink-0">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-gray-900 tracking-tight">Calc 1 Exam Prep</h1>
            <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold mt-1">Interactive Trainer</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div class="nav-item active" onclick="window.app.navigate('overview')">
                <span class="mr-3">üìä</span> Dashboard
            </div>
            <div class="my-4 border-t border-gray-100"></div>
            <div class="nav-item" onclick="window.app.navigate('optimization')">
                <span class="mr-3">üèÜ</span> Optimization
            </div>
            <div class="nav-item" onclick="window.app.navigate('ftc')">
                <span class="mr-3">üìú</span> FTC & Integrals
            </div>
            <div class="nav-item" onclick="window.app.navigate('substitution')">
                <span class="mr-3">üîÑ</span> Substitution
            </div>
            <div class="nav-item" onclick="window.app.navigate('riemann')">
                <span class="mr-3">üìè</span> Riemann Sums
            </div>
            <div class="nav-item" onclick="window.app.navigate('antiderivatives')">
                <span class="mr-3">‚Ü©Ô∏è</span> Antiderivatives
            </div>
        </nav>

        <div class="p-4 bg-blue-50 border-t border-blue-100">
            <div class="text-xs font-semibold text-blue-800 mb-2 uppercase">Total Mastery</div>
            <div class="w-full bg-blue-200 rounded-full h-2.5">
                <div id="sidebar-progress" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="text-right text-xs text-blue-800 mt-1 font-bold" id="sidebar-progress-text">0%</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto relative scroll-smooth p-4 md:p-8" id="main-container">
        
        <!-- VIEW: DASHBOARD OVERVIEW -->
        <div id="overview" class="content-view active max-w-5xl mx-auto">
            <header class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Study Dashboard</h2>
                <p class="text-gray-600">Track your progress across all exam topics.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Mastery Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-1">
                    <h3 class="font-semibold text-gray-700 mb-4">Topic Mastery</h3>
                    <div class="chart-wrapper">
                        <canvas id="masteryChart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                        <p class="text-3xl font-bold text-blue-600" id="total-score-display">0/20</p>
                        <p class="text-xs text-gray-500">Questions Mastered</p>
                    </div>
                </div>

                <!-- Priority List -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-2">
                    <h3 class="font-semibold text-gray-700 mb-4">Recommended Study Path</h3>
                    <div class="space-y-3">
                        <div onclick="window.app.navigate('optimization')" class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-100 transition group">
                            <div>
                                <div class="font-bold text-blue-900 group-hover:text-blue-700 transition">1. Optimization (30 pts)</div>
                                <div class="text-xs text-blue-600">Word problems & graphs. High value.</div>
                            </div>
                            <span class="text-2xl group-hover:translate-x-1 transition">üëâ</span>
                        </div>
                        <div onclick="window.app.navigate('ftc')" class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-100 cursor-pointer hover:bg-green-100 transition group">
                            <div>
                                <div class="font-bold text-green-900 group-hover:text-green-700 transition">2. FTC & Integrals (32 pts)</div>
                                <div class="text-xs text-green-600">Core mechanics. Largest section.</div>
                            </div>
                            <span class="text-2xl group-hover:translate-x-1 transition">üëâ</span>
                        </div>
                         <div onclick="window.app.navigate('substitution')" class="flex items-center justify-between p-4 bg-amber-50 rounded-lg border border-amber-100 cursor-pointer hover:bg-amber-100 transition group">
                            <div>
                                <div class="font-bold text-amber-900 group-hover:text-amber-700 transition">3. Substitution (22 pts)</div>
                                <div class="text-xs text-amber-600">Tricky integrals. Don't forget bounds!</div>
                            </div>
                            <span class="text-2xl group-hover:translate-x-1 transition">üëâ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DYNAMIC TOPIC CONTAINER -->
        <div id="topic-container" class="max-w-6xl mx-auto hidden">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-gray-50 z-10 pt-2 backdrop-blur-sm bg-opacity-90">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900" id="topic-title">Topic Title</h2>
                    <p class="text-gray-600" id="topic-desc">Description</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Mode Switcher -->
                    <div class="bg-white p-1 rounded-lg border shadow-sm flex">
                        <button onclick="window.app.setMode('study')" id="btn-mode-study" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-gray-100 text-gray-900 shadow-sm">üìñ Study</button>
                        <button onclick="window.app.setMode('practice')" id="btn-mode-practice" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-900">‚ö° Practice</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- LEFT: Concepts (Sticky) -->
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 sticky top-24" id="concept-card-style">
                        <h3 class="font-bold text-xl mb-4 flex items-center" id="concept-title">
                            üí° Key Concepts
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700 leading-relaxed" id="concept-content">
                            <!-- Concepts injected here -->
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Questions Container -->
                <div class="lg:col-span-8">
                    <!-- STUDY MODE LIST -->
                    <div id="study-mode-content" class="space-y-6"></div>

                    <!-- PRACTICE MODE GENERATOR -->
                    <div id="practice-mode-content" class="hidden space-y-6">
                        <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-8 text-center" id="practice-placeholder">
                            <div class="text-4xl mb-4">‚ö°</div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Infinite Practice Mode</h3>
                            <p class="text-gray-600 mb-6">Generate unlimited variations of questions for this topic.</p>
                            <button onclick="window.app.generatePracticeQuestion()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-lg transform hover:-translate-y-0.5">
                                Generate New Question
                            </button>
                        </div>
                        <div id="generated-question-container" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- UTILS ---
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const randChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];

        // --- GENERATORS ---
        const generators = {
            'optimization': () => {
                let k, wSq, D, xSol;
                const scenario = randInt(1, 2);
                if (scenario === 1) {
                    k = 2; const leg = randChoice([10, 20, 30]); wSq = 3 * leg * leg; D = leg + randChoice([10, 20]); xSol = D - leg;
                } else {
                    k = 1.25; const leg = randChoice([12, 24]); const w = leg * 0.75; wSq = w*w; D = leg + randChoice([10, 20]); xSol = D - leg;
                }
                return {
                    type: 'frq', title: "Captain Efficiency (Variant)",
                    question: `Swimming energy cost is $${k}$ times running cost. Canal width is $\\sqrt{${wSq}}$ m. Run $x$ m then swim to point ${D} m downstream. Minimize energy. Find $x$.`,
                    answerCriteria: { exact: xSol.toString() },
                    solution: `1. $k=${k}$, Width $w=\\sqrt{${wSq}}$. <br> 2. Optimal condition: $\\frac{w}{\\sqrt{k^2-1}} = D-x$. <br> 3. Solve for x. <br> **Answer: ${xSol}**.`
                };
            },
            'ftc': () => {
                const lower = randInt(-5, 5); const exponent = randInt(2, 3); const upperFn = (exponent === 2) ? "x^2" : "x^3"; const innerFnTex = `\\cos(t)`; const innerFnEval = (exponent === 2) ? `\\cos(x^2)` : `\\cos(x^3)`; const deriv = (exponent === 2) ? `2x` : `3x^2`;
                const options = [`$${deriv}${innerFnEval}$`, `$${innerFnEval}$`, `$${innerFnEval} + C$`, `$\\sin(${upperFn})$`];
                const correctIdx = 0; 
                const shuffled = options.map((val, i) => ({val, i})).sort(() => Math.random() - 0.5);
                return {
                    type: 'mc', title: "FTC Part 1 Chain Rule",
                    question: `Find $\\frac{d}{dx} \\int_{${lower}}^{${upperFn}} ${innerFnTex} dt$.`,
                    options: shuffled.map(s => s.val), correct: shuffled.findIndex(s => s.i === correctIdx),
                    explanation: `Use Chain Rule: $f(g(x)) \\cdot g'(x)$. Answer = $\\cos(${upperFn}) \\cdot (${deriv})$.`
                };
            },
            'riemann': () => {
                const n = 4; const width = randInt(2, 5); const start = randInt(0, 5); const end = start + n * width; const yValues = [randInt(1,8), randInt(1,8), randInt(1,8), randInt(1,8)];
                const sum = yValues.reduce((a,b) => a+b, 0) * width;
                const chartId = 'chartGen' + Math.random().toString(36).substr(2, 9);
                return {
                    type: 'chart-gen', title: "Right Hand Sum",
                    question: `Calculate $R_4$ for $[${start}, ${end}]$.`, chartId: chartId,
                    chartData: { labels: [start, start+width, start+2*width, start+3*width, end], data: [randInt(1,9), ...yValues] },
                    options: [`${sum}`, `${sum + randInt(1,10)}`, `${sum - randInt(1,10)}`, `${sum * 2}`], correct: 0,
                    explanation: `$\\Delta x = ${width}$. Heights: ${yValues.join(', ')}. Sum = ${sum}.`
                };
            },
            'substitution': () => {
                const a = randInt(1, 9); const n = randInt(3, 6); const lower = 0; const upper = 1; const uLower = lower**2 + a; const uUpper = upper**2 + a;
                const options = [`$\\int_{${uLower}}^{${uUpper}} \\frac{1}{2} u^{${n}} du$`, `$\\int_{${lower}}^{${upper}} \\frac{1}{2} u^{${n}} du$`, `$\\int_{${uLower}}^{${uUpper}} u^{${n}} du$`, `$\\int_{${uLower}}^{${uUpper}} 2 u^{${n}} du$`];
                return {
                    type: 'mc', title: "U-Sub with Bounds", question: `Rewrite $\\int_{${lower}}^{${upper}} x(x^2 + ${a})^{${n}} dx$ using $u = x^2 + ${a}$.`,
                    options: options, correct: 0, explanation: `$u = x^2+${a} \\implies \\frac{1}{2}du = x dx$. Bounds: $${uLower}$ to $${uUpper}$.`
                };
            },
            'antiderivatives': () => {
                const C = randInt(1, 10); const k = randInt(2, 5); const targetX = 2; const ans = k*targetX + C;
                return {
                    type: 'mc', title: "Initial Value Problem", question: `If $f'(x) = ${k}$ and $f(0) = ${C}$, find $f(2)$.`,
                    options: [`${ans}`, `${ans+1}`, `${ans-1}`, `${k*2}`], correct: 0, explanation: `$f(x) = \\int ${k} dx = ${k}x + C$. <br> $f(0)=${C} \\implies C=${C}$. <br> $f(${targetX}) = ${k}(${targetX}) + ${C} = ${ans}$.`
                };
            }
        };

        // --- DATA & CONTENT ---
        const topics = {
            'optimization': {
                title: "Optimization", desc: "Finding Max/Min in applied contexts.", color: "blue",
                concepts: `
                    <strong class="block text-gray-900 mb-1">The Protocol:</strong>
                    <ol class="list-decimal list-inside space-y-1 pl-2 mb-4">
                        <li>Draw a picture.</li>
                        <li><strong>Constraint:</strong> What is limited?</li>
                        <li><strong>Objective:</strong> What to max/min?</li>
                        <li>Solve constraint for one var.</li>
                        <li>Plug into Objective.</li>
                        <li>$f'(x) = 0$. Find critical numbers.</li>
                    </ol>
                `,
                questions: [
                    { id: "q1", type: "tf", points: 2, question: "True/False: If c is a critical number and $f''(c)=0$, then f has neither a max nor min at c.", options: ["True", "False"], correct: 1, explanation: "False. Inconclusive." },
                    { id: "q7", type: "chart", points: 4, question: "The graph of derivative $f'(x)$ is shown. Where is the local max?", chartId: "chartQ7", options: ["x=1", "x=2", "x=3", "x=4"], correct: 3, explanation: "Local Max where $f'$ changes + to -." },
                    { 
                        id: "q24", type: "frq", points: 10, title: "Captain Efficiency",
                        question: "Minimize Energy. Swim cost = 2x run cost. Canal width $\\sqrt{300}$. Run $x$, swim to point 40m downstream. Find $x$.",
                        answerCriteria: { exact: "30" },
                        solution: "$x=30$ m."
                    },
                    {
                        id: "q_opt_new1", type: "frq", points: 10, title: "Farmer's Fence (New)",
                        question: "A farmer has 100m of fence to build a rectangular pen against a river (no fence needed on river side). What is the max area?",
                        answerCriteria: { exact: "1250" },
                        solution: "1. Constraint: $2x + y = 100 \\implies y = 100-2x$. <br> 2. Area $A = x(100-2x) = 100x - 2x^2$. <br> 3. $A' = 100 - 4x = 0 \\implies x=25$. <br> 4. Max Area = $25(50) = 1250$."
                    }
                ]
            },
            'ftc': {
                title: "FTC & Integrals", desc: "The Fundamental Theorem.", color: "green", concepts: "Part 1 & 2.",
                questions: [
                    { id: "q11", type: "mc", points: 4, question: "If $g(x)=\\int_{4}^{x}\\frac{1}{1+t}dt$, find $g'(2)$.", options: ["4/3", "2/5", "1/3", "1/5"], correct: 2, explanation: "1/3." },
                    { id: "q12", type: "chart", points: 4, question: "Evaluate $\\int_{1}^{8}f(x)dx$ using the graph.", chartId: "chartQ12", options: ["-5", "-3", "-2", "4"], correct: 2, explanation: "-2." },
                    { 
                        id: "q_ftc_new1", type: "mc", points: 5, title: "Chain Rule (New)",
                        question: "Find $\\frac{d}{dx} \\int_1^{x^3} \\sin(t) dt$.",
                        options: ["$\\sin(x^3)$", "$3x^2 \\sin(x^3)$", "$\\cos(x^3)$", "$3x^2 \\cos(x^3)$"], correct: 1,
                        explanation: "Chain Rule: $f(g(x)) \\cdot g'(x) = \\sin(x^3) \\cdot 3x^2$."
                    },
                    {
                        id: "q_ftc_new2", type: "mc", points: 5, title: "Absolute Value (New)",
                        question: "Evaluate $\\int_{-2}^{2} |x| dx$.",
                        options: ["0", "2", "4", "8"], correct: 2,
                        explanation: "Split into two triangles or use symmetry: $2 \\int_0^2 x dx = 2 [x^2/2]_0^2 = 2(2) = 4$."
                    }
                ]
            },
            'substitution': {
                title: "Substitution Rule", desc: "Reverse Chain Rule.", color: "amber", concepts: "Pick u, du, Bounds.",
                questions: [
                    { id: "q22", type: "mc", points: 4, question: "Transform $\\int_{2}^{3}\\frac{x}{6+x^{2}}dx$ using $u=6+x^2$.", options: ["$\\int_{2}^{3}\\frac{1}{2u}du$", "$\\int_{10}^{15}\\frac{1}{u}du$", "$\\int_{10}^{15}\\frac{1}{2u}du$"], correct: 2, explanation: "Bounds 10 to 15." },
                    { 
                        id: "q23", type: "frq", points: 10, title: "Tricky Substitution",
                        question: "Evaluate $\\int x\\sqrt{1-3x}dx$. (Hint: Result has coefficients 2/27 and 2/45). Type coefficients to verify.",
                        answerCriteria: { keywords: ["2/27", "2/45"] },
                        solution: "Solution involves terms with $2/27$ and $2/45$."
                    },
                    {
                        id: "q_sub_new1", type: "mc", points: 5, title: "Log Sub (New)",
                        question: "Evaluate $\\int \\frac{\\ln x}{x} dx$.",
                        options: ["$\\ln(\\ln x) + C$", "$\\frac{1}{2}(\\ln x)^2 + C$", "$\\frac{1}{x} + C$", "$(\\ln x)^2 + C$"], correct: 1,
                        explanation: "$u = \\ln x, du = (1/x) dx$. Integral becomes $\\int u du = u^2/2 + C$."
                    }
                ]
            },
            'riemann': {
                title: "Riemann Sums", desc: "Approximating Area.", color: "purple", concepts: "Width * Height.",
                questions: [ 
                    { id: "q10", type: "chart", points: 4, question: "Find $R_4$ for [3,15] from graph.", chartId: "chartQ10", options: ["54", "45", "33", "11"], correct: 2, explanation: "Sum = 33." },
                    {
                        id: "q_riem_new1", type: "mc", points: 5, title: "Table Estimation (New)",
                        question: "Given velocities: v(0)=10, v(2)=12, v(4)=15. Estimate distance using Left Sum with $\\Delta t=2$.",
                        options: ["25", "44", "50", "54"], correct: 1,
                        explanation: "Left Sum uses left endpoints (t=0, t=2). $\\Delta t (v(0) + v(2)) = 2(10+12) = 2(22) = 44$."
                    }
                ]
            },
            'antiderivatives': {
                title: "Antiderivatives", desc: "Finding F(x).", color: "gray", concepts: "+C rule.",
                questions: [ 
                    { id: "q14", type: "mc", points: 4, question: "If $f'(x)=3+2\\sin x$ and $f(0)=7$, find $f(\\pi)$.", options: ["$3\\pi+13$", "$3\\pi+11$", "$3\\pi+9$"], correct: 1, explanation: "C=9, Answer $3\\pi+11$." },
                    {
                        id: "q_anti_new1", type: "mc", points: 5, title: "Particle Motion (New)",
                        question: "A particle has acceleration $a(t)=6t$, initial velocity $v(0)=5$, initial position $s(0)=2$. Find position $s(1)$.",
                        options: ["3", "8", "10", "12"], correct: 1,
                        explanation: "$v(t) = 3t^2+5$. $s(t)=t^3+5t+2$. $s(1) = 1+5+2=8$."
                    }
                ]
            }
        };

        // --- APP LOGIC ---
        window.app = {
            currentView: 'overview',
            currentMode: 'study',
            currentTopic: null,
            mastery: new Set(),
            frqAttempts: {},

            init() { this.renderOverviewCharts(); },
            navigate(viewId) {
                document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if(viewId === 'overview') {
                    document.getElementById('overview').classList.add('active');
                    document.getElementById('topic-container').classList.add('hidden');
                    document.querySelector(`.nav-item[onclick="window.app.navigate('overview')"]`).classList.add('active');
                } else {
                    this.renderTopic(viewId);
                    document.getElementById('overview').classList.remove('active');
                    document.getElementById('topic-container').classList.remove('hidden');
                    document.getElementById('topic-container').classList.add('active');
                    document.querySelector(`.nav-item[onclick="window.app.navigate('${viewId}')"]`).classList.add('active');
                }
                if(window.MathJax) MathJax.typesetPromise();
            },
            setMode(mode) {
                this.currentMode = mode;
                const study = document.getElementById('study-mode-content');
                const practice = document.getElementById('practice-mode-content');
                const btnS = document.getElementById('btn-mode-study');
                const btnP = document.getElementById('btn-mode-practice');
                if(mode === 'study') {
                    study.classList.remove('hidden'); practice.classList.add('hidden');
                    btnS.classList.replace('text-gray-500', 'text-gray-900'); btnS.classList.replace('bg-white', 'bg-gray-100'); btnS.classList.add('shadow-sm');
                    btnP.classList.remove('shadow-sm', 'bg-gray-100', 'text-gray-900'); btnP.classList.add('text-gray-500');
                } else {
                    study.classList.add('hidden'); practice.classList.remove('hidden');
                    btnP.classList.replace('text-gray-500', 'text-gray-900'); btnP.classList.add('bg-gray-100', 'shadow-sm');
                    btnS.classList.remove('shadow-sm', 'bg-gray-100', 'text-gray-900'); btnS.classList.add('text-gray-500');
                }
            },
            renderTopic(topicKey) {
                this.currentTopic = topicKey;
                const data = topics[topicKey];
                this.setMode('study');
                document.getElementById('generated-question-container').innerHTML = '';
                document.getElementById('generated-question-container').classList.add('hidden');
                document.getElementById('practice-placeholder').classList.remove('hidden');
                document.getElementById('topic-title').textContent = data.title;
                document.getElementById('topic-title').className = `text-3xl font-bold text-${data.color}-900`;
                document.getElementById('topic-desc').textContent = data.desc;
                document.getElementById('concept-card-style').className = `bg-white p-6 rounded-xl shadow-md border-l-4 border-${data.color}-500 sticky top-24 transition-all`;
                document.getElementById('concept-title').className = `font-bold text-xl mb-4 flex items-center text-${data.color}-900`;
                document.getElementById('concept-content').innerHTML = data.concepts;

                const qList = document.getElementById('study-mode-content');
                qList.innerHTML = '';
                data.questions.forEach((q, index) => {
                    qList.appendChild(this.createQuestionCard(q, index, data.color));
                    if(q.type === 'chart') setTimeout(() => this.initStaticChart(q.chartId), 0);
                });
            },
            createQuestionCard(q, index, color) {
                const qCard = document.createElement('div');
                qCard.className = "bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden transition-all hover:shadow-md";
                let content = `<div class="p-5"><div class="flex justify-between mb-3"><span class="font-bold text-${color}-900">Question ${index+1} (${q.points} pts)</span>`;
                if(this.mastery.has(q.id)) content += `<span class="text-green-600 font-bold text-sm">‚úì Mastered</span>`;
                content += `</div><p class="mb-4 text-gray-800 font-medium">${q.question}</p>`;
                if(q.type === 'chart') content += `<div class="h-64 w-full mb-4"><canvas id="${q.chartId}"></canvas></div>`;

                if(q.type === 'frq') {
                    this.frqAttempts[q.id] = 0; 
                    content += `
                        <div id="frq-container-${q.id}">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="input-${q.id}" placeholder="Type your answer..." class="frq-input" onkeydown="if(event.key==='Enter') window.app.submitFRQ('${q.id}')">
                                <button onclick="window.app.submitFRQ('${q.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Submit</button>
                            </div>
                            <div id="feedback-${q.id}" class="hidden mt-3 p-3 rounded text-sm"></div>
                            <div id="solution-${q.id}" class="hidden mt-3 p-4 bg-${color}-50 rounded border border-${color}-100">
                                <p class="font-bold text-gray-800 mb-1">Solution:</p>
                                <p class="text-sm text-gray-700">${q.solution}</p>
                            </div>
                        </div>
                    `;
                } else {
                    content += `<div class="space-y-2" id="opts-${q.id}">`;
                    q.options.forEach((opt, i) => { content += `<button class="btn-option" onclick="window.app.checkAnswer('${q.id}', ${i}, ${q.correct})">${opt}</button>`; });
                    content += `</div><div id="feedback-${q.id}" class="hidden mt-4 p-3 rounded text-sm"></div>`;
                }
                qCard.innerHTML = content;
                return qCard;
            },
            submitFRQ(qId) {
                let qData = null;
                for(let t in topics) { qData = topics[t].questions.find(x => x.id === qId); if(qData) break; }
                if(!qData) return; 

                const inputEl = document.getElementById(`input-${qId}`);
                const feedbackEl = document.getElementById(`feedback-${qId}`);
                const solutionEl = document.getElementById(`solution-${qId}`);
                let val = inputEl.value.trim();
                if(!val) return;

                let isCorrect = false;
                if(qData.answerCriteria.exact) {
                    const nums = val.match(/-?\d+(\.\d+)?/g);
                    if(nums && nums.includes(qData.answerCriteria.exact)) isCorrect = true;
                    if(val === qData.answerCriteria.exact) isCorrect = true;
                } else if (qData.answerCriteria.keywords) {
                    isCorrect = qData.answerCriteria.keywords.every(k => val.includes(k));
                }

                this.frqAttempts[qId]++;
                const attempts = this.frqAttempts[qId];

                if(isCorrect) {
                    inputEl.classList.remove('error'); inputEl.classList.add('success');
                    inputEl.disabled = true;
                    feedbackEl.className = "mt-3 p-3 bg-green-100 text-green-800 rounded block";
                    feedbackEl.innerHTML = "<strong>Correct!</strong> Great job.";
                    solutionEl.classList.remove('hidden');
                    this.markMastery(qId, true);
                } else {
                    if(attempts >= 3) {
                        inputEl.classList.add('error'); inputEl.disabled = true;
                        feedbackEl.className = "mt-3 p-3 bg-red-100 text-red-800 rounded block";
                        feedbackEl.innerHTML = "<strong>Incorrect.</strong> No attempts left.";
                        solutionEl.classList.remove('hidden');
                    } else {
                        inputEl.classList.add('error');
                        setTimeout(() => inputEl.classList.remove('error'), 500);
                        feedbackEl.className = "mt-3 p-3 bg-yellow-50 text-yellow-800 rounded block";
                        feedbackEl.innerHTML = `<strong>Incorrect.</strong> ${3 - attempts} attempts remaining.`;
                    }
                }
            },
            checkAnswer(qId, selectedIdx, correctIdx) {
                const feedbackEl = document.getElementById(`feedback-${qId}`);
                const optsContainer = document.getElementById(`opts-${qId}`);
                const buttons = optsContainer.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
                if(selectedIdx === correctIdx) {
                    buttons[selectedIdx].classList.add('correct');
                    feedbackEl.className = "mt-4 p-3 bg-green-50 border border-green-200 rounded text-green-800 text-sm block";
                    feedbackEl.innerHTML = `<strong>Correct!</strong> ${this.getExplanation(qId)}`;
                    this.markMastery(qId, true);
                } else {
                    buttons[selectedIdx].classList.add('wrong');
                    buttons[correctIdx].classList.add('correct');
                    feedbackEl.className = "mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-800 text-sm block";
                    feedbackEl.innerHTML = `<strong>Incorrect.</strong> ${this.getExplanation(qId)}`;
                }
            },
            checkPracticeAnswer(btn, isCorrect, qId) {
                const feedbackCorrect = document.getElementById(`feedback-${qId}`);
                const feedbackWrong = document.getElementById(`feedback-wrong-${qId}`);
                const parent = btn.parentElement;
                const siblings = parent.querySelectorAll('button');
                siblings.forEach(sib => sib.disabled = true);
                if(isCorrect) {
                    btn.classList.add('correct'); feedbackCorrect.classList.remove('hidden'); feedbackWrong.classList.add('hidden');
                } else {
                    btn.classList.add('wrong'); feedbackWrong.classList.remove('hidden'); feedbackCorrect.classList.add('hidden');
                }
            },
            generatePracticeQuestion() {
                const generator = generators[this.currentTopic];
                if(!generator) { alert("Coming soon!"); return; }
                const q = generator();
                const qId = 'gen_' + Date.now(); q.id = qId;
                const container = document.getElementById('generated-question-container');
                container.innerHTML = ''; container.classList.remove('hidden');
                document.getElementById('practice-placeholder').classList.add('hidden');
                const card = document.createElement('div');
                card.className = "bg-blue-50 border-2 border-blue-200 rounded-xl shadow-md overflow-hidden animate-fade-in";
                let content = `<div class="p-6"><div class="flex justify-between mb-3"><span class="font-bold text-blue-900 uppercase tracking-wider text-sm">‚ö° Practice: ${q.title}</span><button onclick="window.app.generatePracticeQuestion()" class="text-xs bg-white border px-2 py-1 rounded hover:bg-gray-50">New Q</button></div><p class="mb-6 text-gray-800 text-lg font-medium leading-relaxed">${q.question}</p>`;
                if(q.type === 'chart-gen') content += `<div class="h-64 w-full mb-4 bg-white rounded border"><canvas id="${q.chartId}"></canvas></div>`;
                
                if(q.type === 'frq') {
                    window.currentPracticeAns = q.answerCriteria;
                    window.currentPracticeSol = q.solution;
                    window.currentPracticeAttempts = 0;
                    content += `
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="p-input" placeholder="Answer..." class="frq-input">
                            <button onclick="window.app.submitPracticeFRQ()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Submit</button>
                        </div>
                        <div id="p-feedback" class="hidden mt-3 p-3 rounded text-sm"></div>
                        <div id="p-solution" class="hidden mt-3 p-4 bg-white rounded border border-blue-200"><p>${q.solution}</p></div>
                    `;
                } else {
                    const indices = q.options.map((_, i) => i);
                    for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
                    content += `<div class="grid grid-cols-1 gap-2" id="opts-${qId}">`;
                    indices.forEach(idx => { 
                        content += `<button class="btn-option" onclick="window.app.checkPracticeAnswer(this, ${idx === q.correct}, '${qId}')">${q.options[idx]}</button>`;
                    });
                    content += `</div><div id="feedback-${qId}" class="hidden mt-4 p-4 bg-green-100 text-green-900 rounded-lg"><strong>Correct!</strong> ${q.explanation}</div><div id="feedback-wrong-${qId}" class="hidden mt-4 p-4 bg-red-100 text-red-900 rounded-lg"><strong>Incorrect.</strong></div>`;
                }
                content += `</div>`; card.innerHTML = content; container.appendChild(card);
                if(window.MathJax) MathJax.typesetPromise();
                if(q.type === 'chart-gen') setTimeout(() => {
                    const ctx = document.getElementById(q.chartId).getContext('2d');
                    new Chart(ctx, { 
                        type: 'line', 
                        data: { 
                            labels: q.chartData.labels, 
                            datasets: [{ 
                                label: 'f(x)', 
                                data: q.chartData.data, 
                                borderColor: '#7c3aed', 
                                backgroundColor: 'rgba(124, 58, 237, 0.1)', 
                                borderWidth: 3, 
                                fill: true, 
                                tension: 0.4 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: { display: false } 
                            }, 
                            scales: { 
                                y: { beginAtZero: true } 
                            } 
                        } 
                    });
                }, 50);
            },
            submitPracticeFRQ() {
                const inputEl = document.getElementById('p-input');
                const feedbackEl = document.getElementById('p-feedback');
                const solEl = document.getElementById('p-solution');
                let val = inputEl.value.trim();
                if(!val) return;
                window.currentPracticeAttempts++;
                
                let isCorrect = false;
                if(window.currentPracticeAns.exact) {
                    const nums = val.match(/-?\d+(\.\d+)?/g);
                    if(nums && nums.includes(window.currentPracticeAns.exact)) isCorrect = true;
                }

                if(isCorrect) {
                    inputEl.classList.add('success'); inputEl.disabled = true;
                    feedbackEl.className = "mt-3 p-3 bg-green-100 text-green-800 rounded block";
                    feedbackEl.innerHTML = "<strong>Correct!</strong>";
                    solEl.classList.remove('hidden');
                } else {
                    if(window.currentPracticeAttempts >= 3) {
                        inputEl.classList.add('error'); inputEl.disabled = true;
                        feedbackEl.className = "mt-3 p-3 bg-red-100 text-red-800 rounded block";
                        feedbackEl.innerHTML = "<strong>Incorrect.</strong> No tries left.";
                        solEl.classList.remove('hidden');
                    } else {
                        inputEl.classList.add('error'); setTimeout(()=>inputEl.classList.remove('error'), 500);
                        feedbackEl.className = "mt-3 p-3 bg-yellow-50 text-yellow-800 rounded block";
                        feedbackEl.innerHTML = `Try again. ${3-window.currentPracticeAttempts} left.`;
                    }
                }
            },
            markMastery(qId, isCorrect) { if(isCorrect) this.mastery.add(qId); this.updateMasteryUI(); },
            getExplanation(qId) { for(let t in topics) { const q = topics[t].questions.find(x => x.id === qId); if(q) return q.explanation; } return ""; },
            updateMasteryUI() {
                let totalQ = 0; let masteredQ = this.mastery.size; for(let t in topics) totalQ += topics[t].questions.length;
                const percentage = Math.round((masteredQ / totalQ) * 100);
                document.getElementById('sidebar-progress').style.width = `${percentage}%`; document.getElementById('sidebar-progress-text').textContent = `${percentage}%`; document.getElementById('total-score-display').textContent = `${masteredQ}/${totalQ}`;
                const chart = Chart.getChart("masteryChart"); if(chart) { chart.data.datasets[0].data = [masteredQ, totalQ - masteredQ]; chart.update(); }
            },
            renderOverviewCharts() {
                 new Chart(document.getElementById('masteryChart'), { type: 'doughnut', data: { labels: ['Mastered', 'Remaining'], datasets: [{ data: [0, 20], backgroundColor: ['#2563eb', '#e5e7eb'], borderWidth: 0 }] }, options: { cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            },
            initStaticChart(chartId) {
                const ctx = document.getElementById(chartId).getContext('2d');
                if(Chart.getChart(chartId)) return;
                if(chartId === 'chartQ7') { 
                    new Chart(ctx, { 
                        type: 'line', 
                        data: { 
                            labels: [0, 1, 2, 3, 4, 5, 6], 
                            datasets: [{ 
                                label: "f'(x)", 
                                data: [-2, 0.5, 1.5, 3, 0, -1.5, 1], 
                                borderColor: '#3b82f6', 
                                borderWidth: 3, 
                                tension: 0.4 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: { display: false }, 
                                annotation: { 
                                    annotations: { 
                                        line1: { 
                                            type: 'line', 
                                            scaleID: 'y', 
                                            value: 0, 
                                            borderColor: 'black', 
                                            borderWidth: 1 
                                        } 
                                    } 
                                } 
                            }, 
                            scales: { 
                                y: { grid: { display: false } }, 
                                x: { grid: { display: false } } 
                            } 
                        } 
                    }); 
                }
                else if (chartId === 'chartQ12') { 
                    new Chart(ctx, { 
                        type: 'line', 
                        data: { 
                            labels: [0, 1, 2, 3, 4, 6, 7, 8, 9], 
                            datasets: [{ 
                                data: [0, 1, 2, 0, -2, -2, 0, 1, 2], 
                                borderColor: '#22c55e', 
                                borderWidth: 3, 
                                fill: true, 
                                backgroundColor: 'rgba(34, 197, 94, 0.1)', 
                                tension: 0 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } }, 
                            scales: { y: { grid: { color: (c) => c.tick.value === 0 ? 'black':'#eee'} } } 
                        } 
                    }); 
                }
                else if (chartId === 'chartQ10') { 
                    new Chart(ctx, { 
                        type: 'line', 
                        data: { 
                            labels: [0, 3, 6, 9, 12, 15, 18], 
                            datasets: [{ 
                                data: [9, 7, 4, 3, 1, 3, 5], 
                                borderColor: '#a855f7', 
                                borderWidth: 3, 
                                tension: 0.4 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } } 
                        } 
                    }); 
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
